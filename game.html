<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TheOddOne – Spiel</title>
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="game-container">
    <a href="lobby.html" class="exit-btn" onclick="return confirm('Spiel wirklich verlassen?')">Spiel verlassen</a>
    
    <!-- Header - KOMPAKTER -->
    <div class="game-header">
      <div class="logo"></div>
      <div class="room-info">
        <span id="roomCode">Raum: LOADING</span>
        <span id="playerName">Du: LOADING</span>
      </div>
    </div>

    <!-- Game Status - NUR PHASE & RUNDE (xyz ist dran ENTFERNT) -->
    <div class="game-status-header">
      <div class="game-status-left">
        <div id="gamePhase" class="phase-indicator">Spiel wird geladen...</div>
        <div id="roundCounter" class="round-counter"></div>
      </div>
      <div class="game-status-right">
        <div id="timeRemaining" class="time-remaining"></div>
      </div>
    </div>

    <!-- Word Display - SCHMALER -->
    <div id="wordDisplay" class="word-display" style="display:none;">
      <div class="role-card">
        <h2 id="roleTitle">Deine Rolle</h2>
        <div id="wordText" class="word-text"></div>
        <p id="roleDescription" class="role-description"></p>
      </div>
    </div>

    <!-- Voice Game Area -->
    <div id="voiceGameArea" class="voice-game-area" style="display:none;">
      <h3>Du bist dran!</h3>
      <div class="voice-instructions">
        <h4>Voice-Chat Anweisung</h4>
        <p>Sage jetzt über Discord/Voice-Chat ein Wort, das zu deinem Begriff passt. Klicke dann auf "Fertig", wenn du dein Wort gesagt hast.</p>
      </div>
      <button onclick="nextPlayer()" class="next-player-btn">FERTIG - NÄCHSTER SPIELER</button>
    </div>

    <!-- Voice Waiting Area -->
    <div id="voiceWaitingArea" class="voice-game-area" style="display:none;">
      <h3>Hör zu!</h3>
      <div class="voice-instructions">
        <h4>Der aktuelle Spieler spricht</h4>
        <p><strong id="currentSpeaker">Spieler</strong> ist dran und sagt jetzt ein Wort über Voice-Chat. Höre aufmerksam zu!</p>
      </div>
      <div class="spinner"></div>
      <p>Warte auf nächsten Spieler...</p>
    </div>

    <!-- Players Section - KOMPAKTER -->
    <div class="players-section">
      <h3>Spieler</h3>
      <div id="playersList" class="players-grid"></div>
    </div>

    <!-- Voting Area -->
    <div id="votingArea" class="voting-area" style="display:none;">
      <h3 id="votingTitle">Abstimmung</h3>
      <p id="votingDescription">Wähle den Spieler, von dem du denkst, dass er der Imposter ist:</p>
      <div id="votingButtons" class="voting-buttons"></div>
      <div class="voting-controls">
        <button id="skipVoteBtn" onclick="skipVote()" class="skip-btn">Überspringen</button>
        <button id="confirmVoteBtn" onclick="confirmVote()" class="confirm-btn" style="display:none;">Stimme bestätigen</button>
      </div>
    </div>

    <!-- Imposter Guess Area -->
    <div id="imposterGuessArea" class="imposter-guess-area" style="display:none;">
      <h3>Du bist der Imposter!</h3>
      <p>Hast du das geheime Wort herausgefunden?</p>
      <div class="input-group">
        <input type="text" id="imposterGuess" placeholder="Das geheime Wort ist..." maxlength="30" />
        <button onclick="submitImposterGuess()" class="guess-btn">Wort raten</button>
      </div>
      <button onclick="skipImposterGuess()" class="skip-btn">Noch nicht bereit</button>
    </div>

    <!-- Game End -->
    <div id="gameEndArea" class="game-end" style="display:none;">
      <h2 id="gameResult">Spielende</h2>
      <div id="gameEndDetails"></div>
      <div class="end-game-buttons">
        <button onclick="playAgain()" class="play-again-btn">Nochmal spielen</button>
        <button onclick="backToLobby()" class="back-btn">Zurück zur Lobby</button>
      </div>
    </div>

    <!-- Waiting Area -->
    <div id="waitingArea" class="waiting-area">
      <div class="spinner"></div>
      <p id="waitingText">Warte auf andere Spieler...</p>
    </div>

    <!-- Footer -->
    <div class="footer-links">
      <p>
        <a href="impressum.html">Impressum</a> | 
        <a href="datenschutz.html">Datenschutz</a> | 
        <a href="kontakt.html">Kontakt</a>
      </p>
    </div>
  </div>

  <script>
    // VOICE-ONLY GAME LOGIC - KOMPLETT ÜBERARBEITET
    const urlParams = new URLSearchParams(window.location.search);
    const playerName = urlParams.get("name")?.trim();
    const roomCode = urlParams.get("room");

    // DOM Elements
    const roomCodeEl = document.getElementById("roomCode");
    const playerNameEl = document.getElementById("playerName");
    const gamePhaseEl = document.getElementById("gamePhase");
    const roundCounterEl = document.getElementById("roundCounter");
    const wordDisplayEl = document.getElementById("wordDisplay");
    const roleTitleEl = document.getElementById("roleTitle");
    const wordTextEl = document.getElementById("wordText");
    const roleDescriptionEl = document.getElementById("roleDescription");
    const playersListEl = document.getElementById("playersList");
    const voiceGameAreaEl = document.getElementById("voiceGameArea");
    const voiceWaitingAreaEl = document.getElementById("voiceWaitingArea");
    const currentSpeakerEl = document.getElementById("currentSpeaker");
    const votingAreaEl = document.getElementById("votingArea");
    const votingButtonsEl = document.getElementById("votingButtons");
    const confirmVoteBtnEl = document.getElementById("confirmVoteBtn");
    const imposterGuessAreaEl = document.getElementById("imposterGuessArea");
    const imposterGuessEl = document.getElementById("imposterGuess");
    const gameEndAreaEl = document.getElementById("gameEndArea");
    const gameResultEl = document.getElementById("gameResult");
    const gameEndDetailsEl = document.getElementById("gameEndDetails");
    const waitingAreaEl = document.getElementById("waitingArea");
    const waitingTextEl = document.getElementById("waitingText");

    let socket;
    let gameState = {};
    let myRole = null;
    let selectedVote = null;
    let currentRound = 1;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let isImposter = false;
    let gameSettings = {};

    // Initialisierung
    if (!playerName || !roomCode) {
      alert("Fehler: Spielername oder Raumcode fehlt!");
      window.location.href = "index.html";
    } else {
      roomCodeEl.textContent = `Raum: ${roomCode}`;
      playerNameEl.textContent = `Du: ${playerName}`;
      connectToServer();
    }

    // VOICE-ONLY: Nächster Spieler Button
    function nextPlayer() {
      console.log("FERTIG Button gedrückt - Voice-Chat Wort wurde gesagt");
      
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        console.error("Socket Problem:", socket ? socket.readyState : "null");
        showError("Keine Verbindung zum Server!");
        return;
      }

      if (!roomCode || !playerName) {
        console.error("Fehlende Daten:", { roomCode, playerName });
        showError("Spielerdaten fehlen!");
        return;
      }

      console.log(`Sende nextPlayer für ${playerName} in Raum ${roomCode}`);

      const message = {
        type: "submitWord",
        roomCode: roomCode,
        playerName: playerName,
        word: "[VOICE_CHAT]"
      };

      try {
        socket.send(JSON.stringify(message));
        console.log("Voice-Chat nextPlayer Nachricht gesendet");
        
        hideAllInputs();
        showWaiting("Warte auf nächsten Spieler...");
        
      } catch (error) {
        console.error("Fehler beim Senden:", error);
        showError("Fehler beim Senden der Nachricht!");
      }
    }

    function connectToServer() {
      showWaiting("Verbinde mit dem Spiel...");
      
      socket = new WebSocket("wss://theodd.one/ws");

      socket.onopen = () => {
        console.log("Mit Game-Server verbunden");
        reconnectAttempts = 0;
        
        socket.send(JSON.stringify({
          type: "joinRoom",
          roomCode: roomCode,
          name: playerName
        }));
        
        setTimeout(() => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
              type: "joinGame",
              roomCode: roomCode,
              playerName: playerName
            }));
          }
        }, 500);
      };

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log("Nachricht erhalten:", data.type, data);
          
          switch(data.type) {
            case "gameStarted":
              handleGameStarted(data);
              break;
              
            case "roleAssignment":
              handleRoleAssignment(data);
              break;
              
            case "gameState":
              handleGameStateUpdate(data);
              break;
              
            case "nextPlayerTurn":
              handleNextPlayerTurn(data);
              break;
              
            case "votingPhase":
              handleVotingPhase(data);
              break;
              
            case "playerEliminated":
              handlePlayerEliminated(data);
              break;
              
            case "gameEnded":
              handleGameEnded(data);
              break;
              
            case "noActiveGame":
              console.log("Kein aktives Spiel - zurück zur Lobby");
              showGameMessage("Kein aktives Spiel gefunden. Du wirst zur Lobby weitergeleitet.");
              setTimeout(() => {
                window.location.href = `lobby.html?room=${roomCode}&name=${encodeURIComponent(playerName)}`;
              }, 2000);
              break;
              
            case "error":
              console.error("Server-Fehler:", data.message);
              showError("Fehler: " + data.message);
              break;
              
            case "connected":
              console.log("Verbindung bestätigt:", data.message);
              break;
              
            default:
              console.log("Unbekannte Nachricht:", data);
          }
        } catch (error) {
          console.error("Fehler beim Parsen der Nachricht:", error);
        }
      };

      socket.onerror = (error) => {
        console.error("WebSocket Fehler:", error);
        showWaiting("Verbindungsfehler - versuche erneut...");
      };

      socket.onclose = (event) => {
        console.log("WebSocket geschlossen:", event.code, event.reason);
        
        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          showWaiting(`Verbindung verloren - Reconnect ${reconnectAttempts}/${maxReconnectAttempts}...`);
          
          setTimeout(() => {
            console.log(`Reconnect Versuch ${reconnectAttempts}`);
            connectToServer();
          }, 2000 * reconnectAttempts);
        } else if (reconnectAttempts >= maxReconnectAttempts) {
          showWaiting("Verbindung dauerhaft verloren. Bitte lade die Seite neu.");
        }
      };
    }

    function handleGameStarted(data) {
      console.log("Spiel gestartet! Game-State:", data.gameState);
      gameState = data.gameState;
      gameSettings = data.gameState.settings || {};
      hideWaiting();
      updateGameDisplay();
    }

    function handleRoleAssignment(data) {
      console.log("Rolle zugewiesen:", data.role, data.word ? `Wort: ${data.word}` : "Kein Wort (Imposter)");
      myRole = data.role;
      isImposter = data.role === "imposter";
      const word = data.word;
      
      wordDisplayEl.style.display = "block";
      
      if (isImposter) {
        roleTitleEl.textContent = "Du bist der IMPOSTER!";
        wordTextEl.textContent = "???";
        
        let description = "Du kennst das geheime Wort nicht! Höre gut zu und versuche herauszufinden, was das Wort ist. Verhalte dich unauffällig!";
        
        if (data.hint && gameSettings.imposterHint) {
          description += `\n\nHinweis: ${data.hint}`;
        }
        
        roleDescriptionEl.textContent = description;
        document.querySelector(".role-card").classList.add("imposter");
        
        setupPermanentImposterGuess();
      } else {
        roleTitleEl.textContent = "Du bist ein CREWMATE!";
        wordTextEl.textContent = word;
        roleDescriptionEl.textContent = "Das ist dein geheimes Wort. Sage passende Begriffe dazu über Voice-Chat, aber verrate nicht zu viel! Finde den Imposter!";
        document.querySelector(".role-card").classList.remove("imposter");
      }
    }

    function handleGameStateUpdate(data) {
      console.log(`Game State Update erhalten:`, data.gameState);
      
      gameState = data.gameState;
      updateGameDisplay();
      
      if (gameState.currentPlayer === playerName) {
        console.log(`Du bist jetzt dran! Zeige Voice Game Area`);
        hideWaiting();
        showVoiceGameArea();
      } else {
        if (gameState.phase === "playing") {
          showVoiceWaitingArea(gameState.currentPlayer);
        }
      }
    }

    function handleNextPlayerTurn(data) {
      console.log(`Nächster Spieler ist dran: ${data.currentPlayer}`);
      gameState.currentPlayer = data.currentPlayer;
      gameState.currentPlayerIndex = data.currentPlayerIndex;
      
      updateGameDisplay();
      
      if (data.currentPlayer === playerName) {
        hideWaiting();
        showVoiceGameArea();
      } else {
        showVoiceWaitingArea(data.currentPlayer);
      }
    }

    function handleVotingPhase(data) {
      gamePhaseEl.textContent = "Abstimmungsphase";
      
      hideAllInputs();
      
      if (isImposter) {
        showImposterVotingOptions();
      } else {
        showVoting();
      }
    }

    function handlePlayerEliminated(data) {
      showSuccess(`${data.eliminated} wurde eliminiert! Spiel geht weiter...`);
      gameState = data.gameState;
      updateGameDisplay();
    }

    function handleGameEnded(data) {
      hideAllInputs();
      
      const floating = document.getElementById("floatingImposterGuess");
      if (floating) {
        floating.remove();
      }
      
      gameEndAreaEl.style.display = "block";
      
      if (data.winner === "imposter") {
        gameResultEl.textContent = "Die Imposter haben gewonnen!";
        gameResultEl.style.color = "#C42000";
        gameEndDetailsEl.innerHTML = `
          <p><strong>Imposter:</strong> ${Array.isArray(data.imposters) ? data.imposters.join(", ") : data.imposters}</p>
          <p><strong>Geheimes Wort:</strong> ${data.secretWord}</p>
          <p class="game-end-reason">${data.reason}</p>
        `;
      } else {
        gameResultEl.textContent = "Die Crewmates haben gewonnen!";
        gameResultEl.style.color = "#000000";
        gameEndDetailsEl.innerHTML = `
          <p><strong>Imposter:</strong> ${Array.isArray(data.imposters) ? data.imposters.join(", ") : data.imposters}</p>
          <p><strong>Geheimes Wort:</strong> ${data.secretWord}</p>
          <p class="game-end-reason">${data.reason}</p>
        `;
      }
    }

    function updateGameDisplay() {
      if (!gameState.players) return;
      
      if (gameState.phase === "playing") {
        gamePhaseEl.textContent = "Spielphase";
        
        if (gameState.timeRemaining !== null && gameState.timeRemaining !== undefined) {
          const minutes = Math.floor(gameState.timeRemaining / 60);
          const seconds = gameState.timeRemaining % 60;
          document.getElementById("timeRemaining").textContent = `${minutes}:${seconds.toString().padStart(2, '0')} verbleibend`;
        }
      } else if (gameState.phase === "voting") {
        gamePhaseEl.textContent = "Abstimmungsphase";
      }
      
      roundCounterEl.textContent = `Runde ${gameState.round || 1}`;
      updatePlayersList();
    }

    function updatePlayersList() {
      if (!playersListEl || !gameState.players) return;
      
      playersListEl.innerHTML = "";
      
      gameState.players.forEach(player => {
        const playerDiv = document.createElement("div");
        playerDiv.className = "player-card";
        
        if (player === gameState.currentPlayer) {
          playerDiv.classList.add("current");
        }
        
        if (player === playerName) {
          playerDiv.classList.add("self");
        }
        
        const playerStatus = player === gameState.currentPlayer ? "Spricht..." : "Hört zu...";
        
        playerDiv.innerHTML = `
          <div class="player-name">${player}</div>
          <div class="player-word">${playerStatus}</div>
        `;
        
        playersListEl.appendChild(playerDiv);
      });
    }

    function showVoiceGameArea() {
      console.log("showVoiceGameArea() - Du bist dran!");
      
      hideAllInputs();
      
      const voiceArea = document.getElementById("voiceGameArea");
      if (voiceArea) {
        voiceArea.style.display = "block";
        voiceArea.style.visibility = "visible";
        voiceArea.style.opacity = "1";
        console.log("Voice Game Area angezeigt");
        
        const nextBtn = voiceArea.querySelector(".next-player-btn");
        if (nextBtn) {
          console.log("FERTIG Button gefunden und funktional");
          nextBtn.onclick = nextPlayer;
          nextBtn.style.display = "block";
          nextBtn.style.visibility = "visible";
          nextBtn.style.opacity = "1";
          nextBtn.style.zIndex = "999";
        } else {
          console.error("FERTIG Button nicht gefunden!");
        }
      } else {
        console.error("Voice Game Area Element nicht gefunden!");
      }
    }

    function showVoiceWaitingArea(currentPlayer) {
      hideAllInputs();
      voiceWaitingAreaEl.style.display = "block";
      currentSpeakerEl.textContent = currentPlayer;
    }

    function showVoting() {
      hideAllInputs();
      votingAreaEl.style.display = "block";
      
      votingButtonsEl.innerHTML = "";
      selectedVote = null;
      confirmVoteBtnEl.style.display = "none";
      
      gameState.players.forEach(player => {
        if (player !== playerName) {
          const button = document.createElement("button");
          button.className = "vote-btn";
          button.textContent = player;
          button.onclick = () => selectVote(player, button);
          votingButtonsEl.appendChild(button);
        }
      });
    }

    function hideAllInputs() {
      voiceGameAreaEl.style.display = "none";
      voiceWaitingAreaEl.style.display = "none";
      votingAreaEl.style.display = "none";
      imposterGuessAreaEl.style.display = "none";
      
      const imposterVoting = document.getElementById("imposterVotingOptions");
      if (imposterVoting) {
        imposterVoting.remove();
      }
    }

    function showWaiting(message = "Warte auf andere Spieler...") {
      waitingAreaEl.style.display = "block";
      waitingTextEl.textContent = message;
    }

    function hideWaiting() {
      waitingAreaEl.style.display = "none";
    }

    // FLOATING IMPOSTER GUESS - MIT TOGGLE FUNKTION
    function setupPermanentImposterGuess() {
      const floatingGuess = document.createElement("div");
      floatingGuess.id = "floatingImposterGuess";
      floatingGuess.className = "floating-imposter-guess";
      floatingGuess.innerHTML = `
        <div class="floating-content">
          <button onclick="toggleFloatingGuess()" class="minimize-btn">−</button>
          <h4>Imposter Guess</h4>
          <input type="text" id="floatingGuessInput" placeholder="Das geheime Wort ist..." maxlength="30" />
          <button onclick="submitFloatingGuess()" class="guess-btn">Wort raten</button>
        </div>
      `;
      
      document.body.appendChild(floatingGuess);
      
      document.getElementById("floatingGuessInput").addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitFloatingGuess();
        }
      });
    }

    function toggleFloatingGuess() {
      const floating = document.getElementById("floatingImposterGuess");
      if (floating) {
        floating.classList.toggle("minimized");
        const btn = floating.querySelector(".minimize-btn");
        if (floating.classList.contains("minimized")) {
          btn.textContent = "+";
        } else {
          btn.textContent = "−";
        }
      }
    }

    function submitFloatingGuess() {
      const input = document.getElementById("floatingGuessInput");
      const guess = input.value.trim();
      
      if (guess === "") {
        showError("Bitte gib deine Vermutung ein!");
        return;
      }
      
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        showError("Keine Verbindung zum Server!");
        return;
      }
      
      socket.send(JSON.stringify({
        type: "imposterGuess",
        roomCode: roomCode,
        playerName: playerName,
        guess: guess
      }));
      
      input.value = "";
      showSuccess("Vermutung abgegeben!");
    }

    function showImposterVotingOptions() {
      const imposterVotingDiv = document.createElement("div");
      imposterVotingDiv.id = "imposterVotingOptions";
      imposterVotingDiv.className = "imposter-voting";
      imposterVotingDiv.innerHTML = `
        <h3>Du bist der Imposter!</h3>
        <p>Du kannst abstimmen, das Wort raten oder die Abstimmung überspringen:</p>
        
        <div class="imposter-actions">
          <button onclick="showImposterVoting()" class="vote-btn">
            Abstimmen
          </button>
          <button onclick="showImposterGuessInVoting()" class="guess-btn">
            Wort raten
          </button>
          <button onclick="skipVote()" class="skip-btn">
            Überspringen
          </button>
        </div>
        
        <div id="imposterVotingArea" style="display: none; margin-top: 20px;">
          <h4>Wähle einen Spieler:</h4>
          <div id="imposterVotingButtons" class="voting-buttons"></div>
          <div class="voting-controls">
            <button id="imposterConfirmVoteBtn" onclick="confirmVote()" class="confirm-btn" style="display:none;">
              Stimme bestätigen
            </button>
            <button onclick="hideImposterVoting()" class="skip-btn">
              Zurück
            </button>
          </div>
        </div>
        
        <div id="imposterGuessInVotingArea" style="display: none; margin-top: 20px;">
          <h4>Rate das geheime Wort:</h4>
          <div class="input-group">
            <input type="text" id="imposterVotingGuess" placeholder="Das geheime Wort ist..." maxlength="30" />
            <button onclick="submitImposterVotingGuess()" class="guess-btn">Wort raten</button>
            <button onclick="hideImposterGuess()" class="skip-btn">Zurück</button>
          </div>
        </div>
      `;
      
      const gameStatus = document.querySelector(".game-status-header") || document.querySelector(".game-status");
      if (gameStatus.nextSibling) {
        gameStatus.parentNode.insertBefore(imposterVotingDiv, gameStatus.nextSibling);
      } else {
        gameStatus.parentNode.appendChild(imposterVotingDiv);
      }
    }

    function showImposterVoting() {
      document.querySelector(".imposter-actions").style.display = "none";
      
      const votingArea = document.getElementById("imposterVotingArea");
      votingArea.style.display = "block";
      
      const votingButtons = document.getElementById("imposterVotingButtons");
      votingButtons.innerHTML = "";
      selectedVote = null;
      document.getElementById("imposterConfirmVoteBtn").style.display = "none";
      
      gameState.players.forEach(player => {
        if (player !== playerName) {
          const button = document.createElement("button");
          button.className = "vote-btn";
          button.textContent = player;
          button.onclick = () => selectImposterVote(player, button);
          votingButtons.appendChild(button);
        }
      });
    }

    function selectImposterVote(player, buttonEl) {
      document.querySelectorAll('#imposterVotingButtons .vote-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      buttonEl.classList.add('selected');
      selectedVote = player;
      document.getElementById("imposterConfirmVoteBtn").style.display = "inline-block";
    }

    function hideImposterVoting() {
      document.querySelector(".imposter-actions").style.display = "block";
      document.getElementById("imposterVotingArea").style.display = "none";
      selectedVote = null;
    }

    function showImposterGuessInVoting() {
      document.querySelector(".imposter-actions").style.display = "none";
      
      const guessArea = document.getElementById("imposterGuessInVotingArea");
      guessArea.style.display = "block";
      
      document.getElementById("imposterVotingGuess").focus();
    }

    function hideImposterGuess() {
      document.querySelector(".imposter-actions").style.display = "block";
      document.getElementById("imposterGuessInVotingArea").style.display = "none";
      document.getElementById("imposterVotingGuess").value = "";
    }

    function submitImposterVotingGuess() {
      const guess = document.getElementById("imposterVotingGuess").value.trim();
      
      if (guess === "") {
        showError("Bitte gib deine Vermutung ein!");
        return;
      }
      
      socket.send(JSON.stringify({
        type: "imposterGuess",
        roomCode: roomCode,
        playerName: playerName,
        guess: guess
      }));
      
      document.getElementById("imposterVotingGuess").value = "";
      hideAllInputs();
      showWaiting("Vermutung abgegeben - warte auf Ergebnis...");
    }

    function selectVote(player, buttonEl) {
      document.querySelectorAll('.vote-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      buttonEl.classList.add('selected');
      selectedVote = player;
      confirmVoteBtnEl.style.display = "inline-block";
    }

    function confirmVote() {
      if (!selectedVote) {
        showError("Bitte wähle einen Spieler aus!");
        return;
      }
      
      socket.send(JSON.stringify({
        type: "vote",
        roomCode: roomCode,
        playerName: playerName,
        votedPlayer: selectedVote
      }));
      
      hideAllInputs();
      showWaiting("Stimme abgegeben - warte auf andere...");
    }

    function skipVote() {
      socket.send(JSON.stringify({
        type: "skipVote",
        roomCode: roomCode,
        playerName: playerName
      }));
      
      hideAllInputs();
      showWaiting("Abstimmung übersprungen - warte auf andere...");
    }

    function submitImposterGuess() {
      const guess = imposterGuessEl.value.trim();
      if (guess === "") {
        showError("Bitte gib deine Vermutung ein!");
        return;
      }
      
      socket.send(JSON.stringify({
        type: "imposterGuess",
        roomCode: roomCode,
        playerName: playerName,
        guess: guess
      }));
      
      imposterGuessEl.value = "";
      hideAllInputs();
      showWaiting("Vermutung abgegeben - warte auf Ergebnis...");
    }

    function skipImposterGuess() {
      socket.send(JSON.stringify({
        type: "skipImposterGuess",
        roomCode: roomCode,
        playerName: playerName
      }));
      
      hideAllInputs();
      showWaiting("Noch nicht bereit - warte auf nächste Runde...");
    }

    function playAgain() {
      socket.send(JSON.stringify({
        type: "playAgain",
        roomCode: roomCode,
        playerName: playerName
      }));
      
      currentRound = 1;
      myRole = null;
      isImposter = false;
      selectedVote = null;
      gameEndAreaEl.style.display = "none";
      wordDisplayEl.style.display = "none";
      
      const floating = document.getElementById("floatingImposterGuess");
      if (floating) {
        floating.remove();
      }
      
      showWaiting("Neues Spiel wird gestartet...");
    }

    function backToLobby() {
      window.location.href = `lobby.html?room=${roomCode}&name=${encodeURIComponent(playerName)}`;
    }

    // TOAST FUNKTIONEN
    function showError(message) {
      const toast = document.createElement("div");
      toast.className = "toast error";
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #C42000 0%, #8B0000 100%);
        color: #FFFFFF;
        padding: 12px 20px;
        border-radius: 12px;
        border: 3px solid #000000;
        z-index: 1000;
        box-shadow: 3px 3px 0px #000000;
        animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    function showSuccess(message) {
      const toast = document.createElement("div");
      toast.className = "toast success";
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #000000 0%, #333333 100%);
        color: #FFFFFF;
        padding: 12px 20px;
        border-radius: 12px;
        border: 3px solid #000000;
        z-index: 1000;
        box-shadow: 3px 3px 0px #000000;
        animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function showGameMessage(message) {
      const toast = document.createElement("div");
      toast.className = "toast info";
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #616161 0%, #4D4D4D 100%);
        color: #FFFFFF;
        padding: 12px 20px;
        border-radius: 12px;
        border: 3px solid #000000;
        z-index: 1000;
        box-shadow: 3px 3px 0px #000000;
        animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    // EVENT LISTENERS
    imposterGuessEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitImposterGuess();
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('keypress', function(e) {
        if (e.target && e.target.id === 'imposterVotingGuess' && e.key === 'Enter') {
          submitImposterVotingGuess();
        }
      });
    });

    window.addEventListener("beforeunload", () => {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
    });

    // CSS für Animationen
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { 
          transform: translateX(100%) rotate(5deg); 
          opacity: 0; 
        }
        to { 
          transform: translateX(0) rotate(0deg); 
          opacity: 1; 
        }
      }
    `;
    document.head.appendChild(style);

    // Auto-Fix für Voice Game Area
    setInterval(() => {
      if (gameState.currentPlayer === playerName && 
          document.getElementById("voiceGameArea").style.display === "none" &&
          gameState.phase === "playing") {
        console.log("Auto-Fix: Zeige Voice Game Area für", playerName);
        showVoiceGameArea();
      }
    }, 1000); 

  </script>
</body>
</html>