<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TheOddOne ‚Äì Spiel</title>
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="game-container">
    <a href="lobby.html" class="exit-btn" onclick="return confirm('Spiel wirklich verlassen?')">Spiel verlassen</a>
    
    <!-- Header - KOMPAKTER -->
    <div class="game-header">
      <div class="logo"></div>
      <div class="room-info">
        <span id="roomCode">Raum: LOADING</span>
        <span id="gamePhase">Verbinde...</span>
        <span id="playerName">Du: LOADING</span>
      </div>
    </div>

    <!-- Word Display - SCHMALER -->
    <div id="wordDisplay" class="word-display" style="display:none;">
      <div class="role-card">
        <h2 id="roleTitle">Deine Rolle</h2>
        <div id="wordText" class="word-text"></div>
        <p id="roleDescription" class="role-description"></p>
      </div>
    </div>

    <!-- Voice Game Area -->
    <div id="voiceGameArea" class="voice-game-area" style="display:none;">
      <h3>Du bist dran!</h3>
      <div class="voice-instructions">
        <h4>Voice-Chat Anweisung</h4>
        <p>Sage jetzt √ºber Discord/Voice-Chat ein Wort, das zu deinem Begriff passt. Klicke dann auf "Fertig", wenn du dein Wort gesagt hast.</p>
      </div>
      <button onclick="nextPlayer()" class="next-player-btn">FERTIG - N√ÑCHSTER SPIELER</button>
    </div>

    <!-- Voice Waiting Area -->
    <div id="voiceWaitingArea" class="voice-game-area" style="display:none;">
      <h3>H√∂r zu!</h3>
      <div class="voice-instructions">
        <h4>Der aktuelle Spieler spricht</h4>
        <p><strong id="currentSpeaker">Spieler</strong> ist dran und sagt jetzt ein Wort √ºber Voice-Chat. H√∂re aufmerksam zu!</p>
      </div>
      <div class="spinner"></div>
      <p>Warte auf n√§chsten Spieler...</p>
    </div>

    <!-- Players Section - KOMPAKTER -->
    <div class="players-section">
      <h3>Spieler</h3>
      <div id="playersList" class="players-grid"></div>
    </div>

    <!-- Voting Area -->
    <div id="votingArea" class="voting-area" style="display:none;">
      <h3 id="votingTitle">Abstimmung</h3>
      <p id="votingDescription">W√§hle den Spieler, von dem du denkst, dass er der Imposter ist:</p>
      <div id="votingButtons" class="voting-buttons"></div>
      <div class="voting-controls">
        <button id="skipVoteBtn" onclick="skipVote()" class="skip-btn">√úberspringen</button>
        <button id="confirmVoteBtn" onclick="confirmVote()" class="confirm-btn" style="display:none;">Stimme best√§tigen</button>
      </div>
    </div>

    <!-- Imposter Guess Area -->
    <div id="imposterGuessArea" class="imposter-guess-area" style="display:none;">
      <h3>Du bist der Imposter!</h3>
      <p>Hast du das geheime Wort herausgefunden?</p>
      <div class="input-group">
        <input type="text" id="imposterGuess" placeholder="Das geheime Wort ist..." maxlength="30" />
        <button onclick="submitImposterGuess()" class="guess-btn">Wort raten</button>
      </div>
      <button onclick="skipImposterGuess()" class="skip-btn">Noch nicht bereit</button>
    </div>

    <!-- Game End -->
    <div id="gameEndArea" class="game-end" style="display:none;">
      <h2 id="gameResult">Spielende</h2>
      <div id="gameEndDetails"></div>
      <div class="end-game-buttons">
        <button onclick="playAgain()" class="play-again-btn">Nochmal spielen</button>
        <button onclick="backToLobby()" class="back-btn">Zur√ºck zur Lobby</button>
      </div>
    </div>

    <!-- Waiting Area -->
    <div id="waitingArea" class="waiting-area">
      <div class="spinner"></div>
      <p id="waitingText">Warte auf andere Spieler...</p>
    </div>

    <!-- Footer -->
    <div class="footer-links">
      <p>
        <a href="impressum.html">Impressum</a> | 
        <a href="datenschutz.html">Datenschutz</a> | 
        <a href="kontakt.html">Kontakt</a>
      </p>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const playerName = urlParams.get("name")?.trim();
    const roomCode = urlParams.get("room");

    // DOM Elements
    const roomCodeEl = document.getElementById("roomCode");
    const playerNameEl = document.getElementById("playerName");
    const gamePhaseEl = document.getElementById("gamePhase");
    const wordDisplayEl = document.getElementById("wordDisplay");
    const roleTitleEl = document.getElementById("roleTitle");
    const wordTextEl = document.getElementById("wordText");
    const roleDescriptionEl = document.getElementById("roleDescription");
    const playersListEl = document.getElementById("playersList");
    const voiceGameAreaEl = document.getElementById("voiceGameArea");
    const voiceWaitingAreaEl = document.getElementById("voiceWaitingArea");
    const currentSpeakerEl = document.getElementById("currentSpeaker");
    const votingAreaEl = document.getElementById("votingArea");
    const votingButtonsEl = document.getElementById("votingButtons");
    const confirmVoteBtnEl = document.getElementById("confirmVoteBtn");
    const imposterGuessAreaEl = document.getElementById("imposterGuessArea");
    const imposterGuessEl = document.getElementById("imposterGuess");
    const gameEndAreaEl = document.getElementById("gameEndArea");
    const gameResultEl = document.getElementById("gameResult");
    const gameEndDetailsEl = document.getElementById("gameEndDetails");
    const waitingAreaEl = document.getElementById("waitingArea");
    const waitingTextEl = document.getElementById("waitingText");

    let socket;
    let gameState = {};
    let myRole = null;
    let selectedVote = null;
    let currentRound = 1;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let isImposter = false;
    let gameSettings = {};
    
    // üî• TIMER FIX: Client-side Timer Variablen
    let currentTimer = null;
    let timerDisplay = null;

    // Initialisierung
    if (!playerName || !roomCode) {
      alert("Fehler: Spielername oder Raumcode fehlt!");
      window.location.href = "index.html";
    } else {
      roomCodeEl.textContent = `Raum: ${roomCode}`;
      playerNameEl.textContent = `Du: ${playerName}`;
      connectToServer();
    }

    // üî• TIMER FIX: Synchrone Timer-Anzeige 
    function updateGameDisplay() {
      if (!gameState.players) return;
      
      const roomInfo = document.querySelector('.game-header .room-info');
      if (roomInfo && gameState.phase) {
        let phaseText = gameState.phase === "playing" ? "SPIELPHASE" : 
                       gameState.phase === "voting" ? "ABSTIMMUNG" :
                       gameState.phase === "imposterLastChance" ? "LETZTE CHANCE" : "SPIEL";
        let roundText = `RUNDE ${gameState.round || 1}`;
        let rightText = `DU: ${playerName}`;
        
        // üî• TIMER FIX: Zeige synchrone Timer-Anzeige
        if (timerDisplay && timerDisplay > 0) {
          const minutes = Math.floor(timerDisplay / 60);
          const seconds = timerDisplay % 60;
          rightText = `${minutes}:${seconds.toString().padStart(2, '0')} MIN`;
        }
        
        roomInfo.innerHTML = `
          <span>RAUM: ${roomCode}</span>
          <span style="color: #C42000; font-weight: 700;">${phaseText} ${roundText}</span>
          <span>${rightText}</span>
        `;
      }
      
      updatePlayersList();
    }

    // üî• FIX: Keine doppelten Messages mehr
    function nextPlayer() {
      console.log("üé§ FERTIG Button gedr√ºckt");
      
      const nextBtn = document.querySelector(".next-player-btn");
      if (nextBtn) {
        nextBtn.disabled = true;
        nextBtn.textContent = "GESENDET...";
      }
      
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        console.error("‚ùå Socket Problem");
        showError("Keine Verbindung zum Server!");
        if (nextBtn) {
          nextBtn.disabled = false;
          nextBtn.textContent = "FERTIG - N√ÑCHSTER SPIELER";
        }
        return;
      }

      const message = {
        type: "submitWord",
        roomCode: roomCode,
        playerName: playerName,
        word: "[VOICE_CHAT]"
      };

      try {
        socket.send(JSON.stringify(message));
        console.log("‚úÖ Voice-Chat Nachricht gesendet");
        
        // üî• FIX: Nur Voice Area verstecken, NICHT das globale Waiting zeigen
        setTimeout(() => {
          voiceGameAreaEl.style.display = "none"; // Nur Voice Area verstecken
          // showWaiting() wird vom Server-Response ausgel√∂st, nicht hier!
        }, 500);
        
      } catch (error) {
        console.error("‚ùå Fehler beim Senden:", error);
        showError("Fehler beim Senden!");
        
        if (nextBtn) {
          nextBtn.disabled = false;
          nextBtn.textContent = "FERTIG - N√ÑCHSTER SPIELER";
        }
      }
    }

    function connectToServer() {
      showWaiting("Verbinde mit dem Spiel...");
      
      socket = new WebSocket("wss://theodd.one/ws");

      socket.onopen = () => {
        console.log("Mit Game-Server verbunden");
        reconnectAttempts = 0;
        
        socket.send(JSON.stringify({
          type: "joinRoom",
          roomCode: roomCode,
          name: playerName
        }));
        
        setTimeout(() => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
              type: "joinGame",
              roomCode: roomCode,
              playerName: playerName
            }));
          }
        }, 500);
      };

      // üî• BUG FIX: Erweiterte Message Handler
      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log("Nachricht erhalten:", data.type, data);
          
          switch(data.type) {
            case "gameStarted":
              handleGameStarted(data);
              break;
              
            case "roleAssignment":
              handleRoleAssignment(data);
              break;
              
            case "gameState":
              handleGameStateUpdate(data);
              break;
              
            case "nextPlayerTurn":
              handleNextPlayerTurn(data);
              break;
              
            case "votingPhase":
              console.log("üó≥Ô∏è Voting Phase gestartet");
              handleVotingPhase(data);
              break;
              
            // üî• NEW: Timer Updates
            case "timerUpdate":
              handleTimerUpdate(data);
              break;
              
            // üî• NEW: Imposter Last Chance
            case "imposterLastChance":
              handleImposterLastChance(data);
              break;
              
            case "playerEliminated":
              handlePlayerEliminated(data);
              break;
              
            case "gameEnded":
              handleGameEnded(data);
              break;
              
            case "noActiveGame":
              console.log("Kein aktives Spiel - zur√ºck zur Lobby");
              showGameMessage("Kein aktives Spiel gefunden. Du wirst zur Lobby weitergeleitet.");
              setTimeout(() => {
                window.location.href = `lobby.html?room=${roomCode}&name=${encodeURIComponent(playerName)}`;
              }, 2000);
              break;
              
            case "error":
              console.error("Server-Fehler:", data.message);
              showError("Fehler: " + data.message);
              break;
              
            case "connected":
              console.log("Verbindung best√§tigt:", data.message);
              break;
              
            default:
              console.log("Unbekannte Nachricht:", data);
          }
        } catch (error) {
          console.error("Fehler beim Parsen der Nachricht:", error);
        }
      };

      socket.onerror = (error) => {
        console.error("WebSocket Fehler:", error);
        showWaiting("Verbindungsfehler - versuche erneut...");
      };

      socket.onclose = (event) => {
        console.log("WebSocket geschlossen:", event.code, event.reason);
        
        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          showWaiting(`Verbindung verloren - Reconnect ${reconnectAttempts}/${maxReconnectAttempts}...`);
          
          setTimeout(() => {
            console.log(`Reconnect Versuch ${reconnectAttempts}`);
            connectToServer();
          }, 2000 * reconnectAttempts);
        } else if (reconnectAttempts >= maxReconnectAttempts) {
          showWaiting("Verbindung dauerhaft verloren. Bitte lade die Seite neu.");
        }
      };
    }

    // üî• TIMER FIX: Synchroner Timer Handler
    function handleTimerUpdate(data) {
      timerDisplay = data.timeRemaining;
      updateGameDisplay();
      
      // Warnung bei wenig Zeit
      if (data.timeRemaining <= 10 && data.timeRemaining > 0) {
        if (data.timeRemaining === 10) {
          showGameMessage("‚è∞ Nur noch 10 Sekunden!");
        }
      }
    }

    function handleGameStarted(data) {
      console.log("Spiel gestartet! Game-State:", data.gameState);
      gameState = data.gameState;
      gameSettings = data.gameState.settings || {};
      hideWaiting();
      updateGameDisplay();
    }

    function handleRoleAssignment(data) {
      console.log("Rolle zugewiesen:", data.role, data.word ? `Wort: ${data.word}` : "Kein Wort (Imposter)");
      myRole = data.role;
      isImposter = data.role === "imposter";
      const word = data.word;
      
      wordDisplayEl.style.display = "block";
      
      if (isImposter) {
        roleTitleEl.textContent = "Du bist der IMPOSTER!";
        wordTextEl.textContent = "???";
        
        let description = "Du kennst das geheime Wort nicht! H√∂re gut zu und versuche herauszufinden, was das Wort ist. Verhalte dich unauff√§llig!";
        
        if (data.hint && gameSettings.imposterHint) {
          description += `\n\nHinweis: ${data.hint}`;
        }
        
        roleDescriptionEl.textContent = description;
        document.querySelector(".role-card").classList.add("imposter");
        
        setupPermanentImposterGuess();
      } else {
        roleTitleEl.textContent = "Du bist ein CREWMATE!";
        wordTextEl.textContent = word;
        roleDescriptionEl.textContent = "Das ist dein geheimes Wort. Sage passende Begriffe dazu √ºber Voice-Chat, aber verrate nicht zu viel! Finde den Imposter!";
        document.querySelector(".role-card").classList.remove("imposter");
      }
    }

    function handleGameStateUpdate(data) {
      console.log(`Game State Update erhalten:`, data.gameState);
      
      gameState = data.gameState;
      updateGameDisplay();
      
      if (gameState.currentPlayer === playerName) {
        console.log(`Du bist jetzt dran! Zeige Voice Game Area`);
        hideWaiting();
        showVoiceGameArea();
      } else {
        if (gameState.phase === "playing") {
          showVoiceWaitingArea(gameState.currentPlayer);
        }
      }
    }

    function handleNextPlayerTurn(data) {
      console.log(`N√§chster Spieler ist dran: ${data.currentPlayer}`);
      gameState.currentPlayer = data.currentPlayer;
      gameState.currentPlayerIndex = data.currentPlayerIndex;
      
      updateGameDisplay();
      
      if (data.currentPlayer === playerName) {
        hideWaiting();
        showVoiceGameArea();
      } else {
        showVoiceWaitingArea(data.currentPlayer);
      }
    }

    function handleVotingPhase(data) {
      console.log("üó≥Ô∏è Voting Phase Handler - Data:", data);
      
      // Update game state
      if (data.gameState) {
        gameState = data.gameState;
        updateGameDisplay();
      }
      
      hideAllInputs();
      
      if (isImposter) {
        console.log("üïµÔ∏è Zeige Imposter Voting Options");
        showImposterVotingOptions();
      } else {
        console.log("üë• Zeige Standard Voting");
        showVoting();
      }
      
      // Show forced voting message if applicable
      if (data.forced) {
        showGameMessage("Zeit abgelaufen - Zwangsabstimmung!");
      }
    }

    // üî• NEW: Imposter Last Chance Handler
    function handleImposterLastChance(data) {
      console.log("üïµÔ∏è Imposter Last Chance Phase gestartet:", data);
      
      gameState = data.gameState;
      updateGameDisplay();
      hideAllInputs();
      
      const eliminatedImposter = data.eliminatedImposter;
      
      if (playerName === eliminatedImposter) {
        // Du bist der eliminierte Imposter - zeige Last Chance Interface
        showImposterLastChance();
      } else {
        // Andere Spieler - zeige Waiting mit Info
        showWaiting(`${eliminatedImposter} wurde eliminiert! Er hat 30 Sekunden f√ºr eine letzte Vermutung...`);
      }
    }

    function handlePlayerEliminated(data) {
      showSuccess(`${data.eliminated} wurde eliminiert! Spiel geht weiter...`);
      gameState = data.gameState;
      updateGameDisplay();
    }

    function handleGameEnded(data) {
      hideAllInputs();
      
      const floating = document.getElementById("floatingImposterGuess");
      if (floating) {
        floating.remove();
      }
      
      gameEndAreaEl.style.display = "block";
      
      if (data.winner === "imposter") {
        gameResultEl.textContent = "Die Imposter haben gewonnen!";
        gameResultEl.style.color = "#C42000";
        gameEndDetailsEl.innerHTML = `
          <p><strong>Imposter:</strong> ${Array.isArray(data.imposters) ? data.imposters.join(", ") : data.imposters}</p>
          <p><strong>Geheimes Wort:</strong> ${data.secretWord}</p>
          <p class="game-end-reason">${data.reason}</p>
        `;
      } else {
        gameResultEl.textContent = "Die Crewmates haben gewonnen!";
        gameResultEl.style.color = "#000000";
        gameEndDetailsEl.innerHTML = `
          <p><strong>Imposter:</strong> ${Array.isArray(data.imposters) ? data.imposters.join(", ") : data.imposters}</p>
          <p><strong>Geheimes Wort:</strong> ${data.secretWord}</p>
          <p class="game-end-reason">${data.reason}</p>
        `;
      }
    }

    // üî• FIX: Verbesserte Spieler-Liste ohne Scrollbar
    function updatePlayersList() {
      if (!playersListEl || !gameState.players) return;
      
      playersListEl.innerHTML = "";
      
      // üî• FIX: Kompakte Ansicht bei vielen Spielern
      if (gameState.players.length > 6) {
        playersListEl.classList.add("compact");
      } else {
        playersListEl.classList.remove("compact");
      }
      
      gameState.players.forEach(player => {
        const playerDiv = document.createElement("div");
        playerDiv.className = "player-card";
        
        if (player === gameState.currentPlayer) {
          playerDiv.classList.add("current");
        }
        
        if (player === playerName) {
          playerDiv.classList.add("self");
        }
        
        const playerStatus = player === gameState.currentPlayer ? "Spricht..." : "H√∂rt zu...";
        
        playerDiv.innerHTML = `
          <div class="player-name">${player}</div>
          <div class="player-word">${playerStatus}</div>
        `;
        
        playersListEl.appendChild(playerDiv);
      });
    }

    function showVoiceGameArea() {
      console.log("üé§ showVoiceGameArea() - Du bist dran!");
      
      hideAllInputs();
      
      const voiceArea = document.getElementById("voiceGameArea");
      if (voiceArea) {
        voiceArea.style.display = "block";
        voiceArea.style.visibility = "visible";
        voiceArea.style.opacity = "1";
        
        const nextBtn = voiceArea.querySelector(".next-player-btn");
        if (nextBtn) {
          // Button Status zur√ºcksetzen
          nextBtn.disabled = false;
          nextBtn.textContent = "FERTIG - N√ÑCHSTER SPIELER";
          nextBtn.onclick = nextPlayer;
          nextBtn.style.display = "block";
          nextBtn.style.visibility = "visible";
          nextBtn.style.opacity = "1";
          console.log("‚úÖ FERTIG Button bereit");
        }
      }
    }

    function showVoiceWaitingArea(currentPlayer) {
      hideAllInputs();
      voiceWaitingAreaEl.style.display = "block";
      currentSpeakerEl.textContent = currentPlayer;
    }

    function showVoting() {
      hideAllInputs();
      votingAreaEl.style.display = "block";
      
      votingButtonsEl.innerHTML = "";
      selectedVote = null;
      confirmVoteBtnEl.style.display = "none";
      
      gameState.players.forEach(player => {
        if (player !== playerName) {
          const button = document.createElement("button");
          button.className = "vote-btn";
          button.textContent = player;
          button.onclick = () => selectVote(player, button);
          votingButtonsEl.appendChild(button);
        }
      });
    }

    function hideAllInputs() {
      voiceGameAreaEl.style.display = "none";
      voiceWaitingAreaEl.style.display = "none";
      votingAreaEl.style.display = "none";
      imposterGuessAreaEl.style.display = "none";
      
      const imposterVoting = document.getElementById("imposterVotingOptions");
      if (imposterVoting) {
        imposterVoting.remove();
      }
      
      // üî• NEW: Remove Last Chance Interface
      const lastChance = document.getElementById("imposterLastChance");
      if (lastChance) {
        lastChance.remove();
      }
    }

    function showWaiting(message = "Warte auf andere Spieler...") {
      waitingAreaEl.style.display = "block";
      waitingTextEl.textContent = message;
    }

    function hideWaiting() {
      waitingAreaEl.style.display = "none";
    }

    // FLOATING IMPOSTER GUESS - MIT TOGGLE FUNKTION
    function setupPermanentImposterGuess() {
      const floatingGuess = document.createElement("div");
      floatingGuess.id = "floatingImposterGuess";
      floatingGuess.className = "floating-imposter-guess";
      floatingGuess.innerHTML = `
        <div class="floating-content">
          <button onclick="toggleFloatingGuess()" class="minimize-btn">‚àí</button>
          <h4>Imposter Guess</h4>
          <input type="text" id="floatingGuessInput" placeholder="Das geheime Wort ist..." maxlength="30" />
          <button onclick="submitFloatingGuess()" class="guess-btn">Wort raten</button>
        </div>
      `;
      
      document.body.appendChild(floatingGuess);
      
      document.getElementById("floatingGuessInput").addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitFloatingGuess();
        }
      });
    }

    function toggleFloatingGuess() {
      const floating = document.getElementById("floatingImposterGuess");
      if (floating) {
        floating.classList.toggle("minimized");
        const btn = floating.querySelector(".minimize-btn");
        if (floating.classList.contains("minimized")) {
          btn.textContent = "+";
        } else {
          btn.textContent = "‚àí";
        }
      }
    }

    function submitFloatingGuess() {
      const input = document.getElementById("floatingGuessInput");
      const guess = input.value.trim();
      
      if (guess === "") {
        showError("Bitte gib deine Vermutung ein!");
        return;
      }
      
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        showError("Keine Verbindung zum Server!");
        return;
      }
      
      socket.send(JSON.stringify({
        type: "imposterGuess",
        roomCode: roomCode,
        playerName: playerName,
        guess: guess
      }));
      
      input.value = "";
      showSuccess("Vermutung abgegeben!");
    }

    // üî• NEW: Imposter Last Chance UI
    function showImposterLastChance() {
      const lastChanceDiv = document.createElement("div");
      lastChanceDiv.id = "imposterLastChance";
      lastChanceDiv.className = "imposter-last-chance";
      lastChanceDiv.innerHTML = `
        <div class="last-chance-content">
          <h2>üïµÔ∏è LETZTE CHANCE!</h2>
          <p>Du wurdest eliminiert, aber du hast <strong>30 Sekunden</strong> f√ºr eine letzte Vermutung!</p>
          
          <div class="countdown" id="lastChanceCountdown">30</div>
          
          <div class="input-group">
            <input type="text" id="lastChanceGuess" placeholder="Das geheime Wort ist..." maxlength="30" />
            <button onclick="submitLastChanceGuess()" class="guess-btn">LETZTER VERSUCH!</button>
          </div>
          
          <p class="warning">‚ö†Ô∏è Bei falschem Guess verlierst du das Spiel!</p>
        </div>
      `;
      
      document.querySelector('.game-container').appendChild(lastChanceDiv);
      
      // Focus auf Input
      document.getElementById("lastChanceGuess").focus();
      
      // Enter-Key Support
      document.getElementById("lastChanceGuess").addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitLastChanceGuess();
        }
      });
      
      // Countdown Timer
      let timeLeft = 30;
      const countdownInterval = setInterval(() => {
        timeLeft--;
        const countdownEl = document.getElementById("lastChanceCountdown");
        if (countdownEl) {
          countdownEl.textContent = timeLeft;
          
          // Farbe √§ndern bei wenig Zeit
          if (timeLeft <= 10) {
            countdownEl.style.color = "#C42000";
            countdownEl.style.animation = "pulse 1s infinite";
          }
          
          if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            showError("Zeit abgelaufen! Crewmates gewinnen.");
            
            // Remove Last Chance Interface
            const lastChance = document.getElementById("imposterLastChance");
            if (lastChance) {
              lastChance.remove();
            }
          }
        } else {
          clearInterval(countdownInterval);
        }
      }, 1000);
    }

    function submitLastChanceGuess() {
      const guess = document.getElementById("lastChanceGuess").value.trim();
      
      if (guess === "") {
        showError("Bitte gib deine letzte Vermutung ein!");
        return;
      }
      
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        showError("Keine Verbindung zum Server!");
        return;
      }
      
      // Button deaktivieren
      const button = document.querySelector("#imposterLastChance .guess-btn");
      if (button) {
        button.disabled = true;
        button.textContent = "GESENDET...";
      }
      
      socket.send(JSON.stringify({
        type: "imposterGuess",
        roomCode: roomCode,
        playerName: playerName,
        guess: guess
       }));
      
      // Remove Last Chance Interface nach dem Senden
      setTimeout(() => {
        const lastChance = document.getElementById("imposterLastChance");
        if (lastChance) {
          lastChance.remove();
        }
        showWaiting("Letzte Vermutung abgegeben - warte auf Ergebnis...");
      }, 500);
    }

    function showImposterVotingOptions() {
      const imposterVotingDiv = document.createElement("div");
      imposterVotingDiv.id = "imposterVotingOptions";
      imposterVotingDiv.className = "imposter-voting";
      imposterVotingDiv.innerHTML = `
        <h3>Du bist der Imposter!</h3>
        <p>Du kannst das geheime Wort raten oder die Abstimmung √ºberspringen:</p>
        
        <div class="imposter-actions">
          <button onclick="showImposterGuessInVoting()" class="guess-btn">
            Wort raten
          </button>
          <button onclick="skipVote()" class="skip-btn">
            √úberspringen
          </button>
        </div>
        
        <div id="imposterGuessInVotingArea" style="display: none; margin-top: 20px;">
          <h4>Rate das geheime Wort:</h4>
          <div class="input-group">
            <input type="text" id="imposterVotingGuess" placeholder="Das geheime Wort ist..." maxlength="30" />
            <button onclick="submitImposterVotingGuess()" class="guess-btn">Wort raten</button>
            <button onclick="hideImposterGuess()" class="skip-btn">Zur√ºck</button>
          </div>
        </div>
      `;
      
      const gameContainer = document.querySelector('.game-container');
      if (gameContainer) {
        gameContainer.appendChild(imposterVotingDiv);
      }
    }

    function showImposterGuessInVoting() {
      document.querySelector(".imposter-actions").style.display = "none";
      
      const guessArea = document.getElementById("imposterGuessInVotingArea");
      guessArea.style.display = "block";
      
      document.getElementById("imposterVotingGuess").focus();
    }

    function hideImposterGuess() {
      document.querySelector(".imposter-actions").style.display = "block";
      document.getElementById("imposterGuessInVotingArea").style.display = "none";
      document.getElementById("imposterVotingGuess").value = "";
    }

    function submitImposterVotingGuess() {
      const guess = document.getElementById("imposterVotingGuess").value.trim();
      
      if (guess === "") {
        showError("Bitte gib deine Vermutung ein!");
        return;
      }
      
      socket.send(JSON.stringify({
        type: "imposterGuess",
        roomCode: roomCode,
        playerName: playerName,
        guess: guess
      }));
      
      document.getElementById("imposterVotingGuess").value = "";
      hideAllInputs();
      showWaiting("Vermutung abgegeben - warte auf Ergebnis...");
    }

    function selectVote(player, buttonEl) {
      document.querySelectorAll('.vote-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      buttonEl.classList.add('selected');
      selectedVote = player;
      confirmVoteBtnEl.style.display = "inline-block";
    }

    function confirmVote() {
      if (!selectedVote) {
        showError("Bitte w√§hle einen Spieler aus!");
        return;
      }
      
      socket.send(JSON.stringify({
        type: "vote",
        roomCode: roomCode,
        playerName: playerName,
        votedPlayer: selectedVote
      }));
      
      hideAllInputs();
      showWaiting("Stimme abgegeben - warte auf andere...");
    }

    function skipVote() {
      socket.send(JSON.stringify({
        type: "skipVote",
        roomCode: roomCode,
        playerName: playerName
      }));
      
      hideAllInputs();
      showWaiting("Abstimmung √ºbersprungen - warte auf andere...");
    }

    function submitImposterGuess() {
      const guess = imposterGuessEl.value.trim();
      if (guess === "") {
        showError("Bitte gib deine Vermutung ein!");
        return;
      }
      
      socket.send(JSON.stringify({
        type: "imposterGuess",
        roomCode: roomCode,
        playerName: playerName,
        guess: guess
      }));
      
      imposterGuessEl.value = "";
      hideAllInputs();
      showWaiting("Vermutung abgegeben - warte auf Ergebnis...");
    }

    function skipImposterGuess() {
      socket.send(JSON.stringify({
        type: "skipImposterGuess",
        roomCode: roomCode,
        playerName: playerName
      }));
      
      hideAllInputs();
      showWaiting("Noch nicht bereit - warte auf n√§chste Runde...");
    }

    function playAgain() {
      socket.send(JSON.stringify({
        type: "playAgain",
        roomCode: roomCode,
        playerName: playerName
      }));
      
      currentRound = 1;
      myRole = null;
      isImposter = false;
      selectedVote = null;
      gameEndAreaEl.style.display = "none";
      wordDisplayEl.style.display = "none";
      
      const floating = document.getElementById("floatingImposterGuess");
      if (floating) {
        floating.remove();
      }
      
      showWaiting("Neues Spiel wird gestartet...");
    }

    function backToLobby() {
      window.location.href = `lobby.html?room=${roomCode}&name=${encodeURIComponent(playerName)}`;
    }

    // TOAST FUNKTIONEN
    function showError(message) {
      const toast = document.createElement("div");
      toast.className = "toast error";
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #C42000 0%, #8B0000 100%);
        color: #FFFFFF;
        padding: 12px 20px;
        border-radius: 12px;
        border: 3px solid #000000;
        z-index: 1000;
        box-shadow: 3px 3px 0px #000000;
        animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    function showSuccess(message) {
      const toast = document.createElement("div");
      toast.className = "toast success";
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #000000 0%, #333333 100%);
        color: #FFFFFF;
        padding: 12px 20px;
        border-radius: 12px;
        border: 3px solid #000000;
        z-index: 1000;
        box-shadow: 3px 3px 0px #000000;
        animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function showGameMessage(message) {
      const toast = document.createElement("div");
      toast.className = "toast info";
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #616161 0%, #4D4D4D 100%);
        color: #FFFFFF;
        padding: 12px 20px;
        border-radius: 12px;
        border: 3px solid #000000;
        z-index: 1000;
        box-shadow: 3px 3px 0px #000000;
        animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    // EVENT LISTENERS
    imposterGuessEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitImposterGuess();
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('keypress', function(e) {
        if (e.target && e.target.id === 'imposterVotingGuess' && e.key === 'Enter') {
          submitImposterVotingGuess();
        }
      });
    });

    window.addEventListener("beforeunload", () => {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
    });

    // CSS f√ºr Animationen und Fixes
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { 
          transform: translateX(100%) rotate(5deg); 
          opacity: 0; 
        }
        to { 
          transform: translateX(0) rotate(0deg); 
          opacity: 1; 
        }
      }
      
      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      
      /* üî• FIX: Spieler-Liste ohne Scrollbar */
      .players-section {
        margin: 16px 0;
        flex-shrink: 0;
        height: 200px;
        overflow: hidden;
      }

      .players-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        height: 100%;
        overflow: hidden;
        align-content: start;
      }

      .players-grid.compact {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
      }

      .players-grid.compact .player-card {
        padding: 8px;
        font-size: 12px;
      }
    `;
    document.head.appendChild(style);

    // Auto-Fix f√ºr Voice Game Area
    setInterval(() => {
      if (gameState.currentPlayer === playerName && 
          document.getElementById("voiceGameArea").style.display === "none" &&
          gameState.phase === "playing") {
        console.log("Auto-Fix: Zeige Voice Game Area f√ºr", playerName);
        showVoiceGameArea();
      }
    }, 1000); 

  </script>
</body>
</html>